// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { HeaderBar, BottomTabBar, NavigationUtils } from "../components/CommonComponents"
import { UserInfo, ApiUserInfo } from "../po/UserInfo"
import { HttpUtils } from "../utils/HttpUtils"
import { ApiResponse } from "../po/CommonTypes"
import { API_BASE_URL } from '../utils/Common';


@Entry
@Component
struct ProfilePage {
  @State userInfo: UserInfo = {
    avatar: 'ğŸ‘¤',
    username: 'åŠ è½½ä¸­...',
    phone: 'åŠ è½½ä¸­...',
    joinDate: 'åŠ è½½ä¸­...',
    publishCount: 5,
    foundCount: 3
  };
  
  @State searchingCount: number = 3;
  @State foundCount: number = 5;
  @State helpOthersCount: number = 2;
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  
  // ç»„ä»¶åˆå§‹åŒ–æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
  aboutToAppear() {
    this.loadUserProfile();
  }
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  private async loadUserProfile() {
    try {
      this.isLoading = true;
      this.errorMessage = '';
      
      // æ¨¡æ‹Ÿç”¨æˆ·IDï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä»ç™»å½•çŠ¶æ€è·å–
      const userId = 'user_12345';
      const url = `${API_BASE_URL}/api/user/profile?userId=${userId}`;
      
      const response = await HttpUtils.get(url);
      const apiResponse: ApiResponse<ApiUserInfo> = JSON.parse(response);
      
      if (apiResponse.code === 200 && apiResponse.data) {
        const userData = apiResponse.data;
        this.userInfo = {
          avatar: userData.avatar || 'ğŸ‘¤',
          username: userData.username || 'æœªçŸ¥ç”¨æˆ·',
          phone: userData.phone || 'æœªç»‘å®š',
          joinDate: userData.registerTime ? userData.registerTime.split(' ')[0] : 'æœªçŸ¥',
          publishCount: this.userInfo.publishCount, // ä¿æŒæ¨¡æ‹Ÿæ•°æ®
          foundCount: this.userInfo.foundCount // ä¿æŒæ¨¡æ‹Ÿæ•°æ®
        };
      } else {
        this.errorMessage = apiResponse.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', apiResponse.message);
      }
    } catch (error) {
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'ä¸ªäººä¸­å¿ƒ',
        showBack: false,
        showAction: false
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          Column() {
            if (this.isLoading) {
              // åŠ è½½çŠ¶æ€
              Column() {
                Text('â³')
                  .fontSize(32)
                  .margin({ bottom: 10 })
                Text('åŠ è½½ç”¨æˆ·ä¿¡æ¯ä¸­...')
                  .fontSize(16)
                  .fontColor('#666666')
              }
              .width('100%')
              .height(150)
              .justifyContent(FlexAlign.Center)
            } else if (this.errorMessage) {
              // é”™è¯¯çŠ¶æ€
              Column() {
                Text('âŒ')
                  .fontSize(32)
                  .margin({ bottom: 10 })
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor('#dc3545')
                  .textAlign(TextAlign.Center)
                  .margin({ bottom: 10 })
                Button('é‡æ–°åŠ è½½')
                  .fontSize(14)
                  .backgroundColor('#667eea')
                  .borderRadius(6)
                  .onClick(() => {
                    this.loadUserProfile();
                  })
              }
              .width('100%')
              .height(150)
              .justifyContent(FlexAlign.Center)
            } else {
              // æ­£å¸¸æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
              Column() {
                // å¤´åƒ
                Stack() {
                  Circle({ width: 80, height: 80 })
                    .fill($r('sys.color.glass_material_outline_secondary'))
                    .border({ width: 2, color: '#ddd', style: BorderStyle.Dashed })
                  
                  if (this.userInfo.avatar.startsWith('http')) {
                    // å¦‚æœæ˜¯ç½‘ç»œå›¾ç‰‡URLï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨Imageç»„ä»¶
                    // ç”±äºArkTSé™åˆ¶ï¼Œæš‚æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
                    Text('ğŸ‘¤')
                      .fontSize(32)
                      .fontColor('#999999')
                  } else {
                    Text(this.userInfo.avatar)
                      .fontSize(32)
                      .fontColor('#999999')
                  }
                }
                .margin({ bottom: 15 })
                
                // ç”¨æˆ·å
                Text(this.userInfo.username)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
                  .margin({ bottom: 5 })
                
                // æ‰‹æœºå·
                Text(`æ‰‹æœºå·ï¼š${this.userInfo.phone}`)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ bottom: 5 })
                
                // æ³¨å†Œæ—¶é—´
                Text(`æ³¨å†Œæ—¶é—´ï¼š${this.userInfo.joinDate}`)
                  .fontSize(14)
                  .fontColor('#666666')
              }
            }
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })

          // æˆ‘å‘å¸ƒçš„æ±‚åŠ©ç»Ÿè®¡å¡ç‰‡
          Column() {
            Row() {
              Text('æˆ‘å‘å¸ƒçš„æ±‚åŠ©')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .layoutWeight(1)
              
              // Text('æŸ¥çœ‹å…¨éƒ¨ >')
              //   .fontSize(14)
              //   .fontColor('#667eea')
              //   .onClick(() => {
              //     console.log('æŸ¥çœ‹å…¨éƒ¨æ±‚åŠ©');
              //   })
            }
            .width('100%')
            .margin({ bottom: 15 })
            
            // ç»Ÿè®¡æ•°æ®
            Row() {
              Column() {
                Text(this.searchingCount.toString())
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#667eea')
                Text('å¯»ç‰©ä¸­')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              
              Column() {
                Text(this.foundCount.toString())
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#28a745')
                Text('å·²æ‰¾åˆ°')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              
              Column() {
                Text(this.helpOthersCount.toString())
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffc107')
                Text('å¸®åŠ©ä»–äºº')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })

          // åŠŸèƒ½èœå•å¡ç‰‡
          Column() {
            // ç¼–è¾‘ä¸ªäººä¿¡æ¯
            // Row() {
            //   Text('ğŸ“ ç¼–è¾‘ä¸ªäººä¿¡æ¯')
            //     .fontSize(16)
            //     .fontColor('#333333')
            //     .layoutWeight(1)
            // }
            // .width('100%')
            // .padding({ top: 10, bottom: 10 })
            // .border({ width: { bottom: 1 }, color: '#eee' })
            // .onClick(() => {
            //   console.log('ç¼–è¾‘ä¸ªäººä¿¡æ¯');
            // })
            
            // æˆ‘çš„ç¤¾åŒº
            Row() {
              Text('ğŸ˜ï¸ æˆ‘çš„ç¤¾åŒº')
                .fontSize(16)
                .fontColor('#333333')
                .layoutWeight(1)
            }
            .width('100%')
            .padding({ top: 10, bottom: 10 })
            .border({ width: { bottom: 1 }, color: '#eee' })
            .onClick(() => {
              router.pushUrl({ url: 'pages/CommunityPage' });
            })
            
            // è®¾ç½®
            // Row() {
            //   Text('âš™ï¸ è®¾ç½®')
            //     .fontSize(16)
            //     .fontColor('#333333')
            //     .layoutWeight(1)
            // }
            // .width('100%')
            // .padding({ top: 10, bottom: 10 })
            // .border({ width: { bottom: 1 }, color: '#eee' })
            // .onClick(() => {
            //   console.log('è®¾ç½®');
            // })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })

          // é€€å‡ºç™»å½•æŒ‰é’®
          Button('é€€å‡ºç™»å½•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#6c757d')
            .backgroundColor('#f8f9fa')
            .border({ width: 1, color: '#dee2e6' })
            .borderRadius(8)
            .margin({ bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/Index' });
            })
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .backgroundColor('#f5f5f5')
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      BottomTabBar({
        currentIndex: 3,
        onTabClick: (index: number) => {
          NavigationUtils.handleTabNavigation(index, 3);
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
