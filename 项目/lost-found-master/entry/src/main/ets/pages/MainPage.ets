// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { LostItem } from "../po/LostItem"
import { HeaderBar, BottomTabBar, StatusTag, CardContainer, NavigationUtils } from "../components/CommonComponents"
import { HttpUtils } from '../utils/HttpUtils';
import { ApiResponse } from '../po/CommonTypes';
import { PostCommunityInfo, PostInfo, SearchResponse } from '../po/MainInfo';
import { API_BASE_URL } from '../utils/Common';

@Entry
@Component
struct MainPage {
  @State searchText: string = '';
  @State selectedFilter: string = 'å¯»ç‰©';
  private filterTabs: string[] = ['å¯»ç‰©', 'å¯»ä¸»', 'å·²æ‰¾åˆ°'];
  @State showCommunityDropdown: boolean = false;
  @State selectedCommunity: string = 'å…¨éƒ¨ç¤¾åŒº';
  @State selectedCommunityId: string = 'comm_12345';
  @State communities: PostCommunityInfo[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';

  // æ•°æ®çŠ¶æ€
  @State lostItems: LostItem[] = [];

  // æœ¬åœ°æ–°å‘å¸ƒçš„å¸–å­åˆ—è¡¨ï¼ˆç”¨äºé˜²æ­¢æ•°æ®è¢«mockå“åº”è¦†ç›–é—®é¢˜ï¼‰
  private localPublishedPosts: LostItem[] = [];

  // è·å–ç¤¾åŒºåˆ—è¡¨
  async getCommunityList(): Promise<void> {
    try {
      this.isLoading = true;
      const url = `${API_BASE_URL}/api/community/my-communities`;
      const response = await HttpUtils.get(url);
      const apiResponse: ApiResponse<PostCommunityInfo[]> = JSON.parse(response);

      if (apiResponse.code === 200 && apiResponse.data) {
        this.communities = apiResponse.data;
        if (this.communities.length > 0) {
          // ä¿æŒé»˜è®¤æ˜¾ç¤º'å…¨éƒ¨ç¤¾åŒº'ï¼Œä½†ä½¿ç”¨ç¬¬ä¸€ä¸ªç¤¾åŒºçš„IDè·å–æ•°æ®
          this.selectedCommunityId = this.communities[0].communityId;
          // è·å–ç¤¾åŒºåˆ—è¡¨åï¼Œè‡ªåŠ¨è·å–ç¬¬ä¸€ä¸ªç¤¾åŒºçš„å‘å¸ƒä¿¡æ¯
          await this.getPostList();
        }
      } else {
        this.errorMessage = apiResponse.message || 'è·å–ç¤¾åŒºåˆ—è¡¨å¤±è´¥';
      }
    } catch (error) {
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error('è·å–ç¤¾åŒºåˆ—è¡¨å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–å‘å¸ƒä¿¡æ¯åˆ—è¡¨
  async getPostList(): Promise<void> {
    try {
      this.isLoading = true;
      const url = `${API_BASE_URL}/api/post/community-list?communityId=${this.selectedCommunityId}`;

      const response = await HttpUtils.get(url);
      const apiResponse: ApiResponse<PostInfo[]> = JSON.parse(response);

      if (apiResponse.code === 200 && apiResponse.data) {
        // å°†PostInfoè½¬æ¢ä¸ºLostItemæ ¼å¼
         const apiPosts = apiResponse.data.map((post: PostInfo): LostItem => {
           const originalTime = post.lostTime || post.publishTime || '';
           return {
             id: post.postId,
             title: post.itemName,
             category: post.itemDescription || 'å…¶ä»–',
             location: post.lostLocation,
             time: this.formatTime(originalTime),
             originalTimestamp: originalTime ? new Date(originalTime).getTime() : 0,
             image: post.images && post.images.length > 0 ? post.images[0] : 'https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B',
             type: post.postType === 'å¯»ç‰©' ? 'å¯»ç‰©' : 'å¯»ä¸»',
             status: post.status === 'å·²æ‰¾åˆ°' ? 'å·²æ‰¾åˆ°' : 'å¯»æ‰¾ä¸­'
           };
         });

         // åˆå¹¶æœ¬åœ°å‘å¸ƒçš„å¸–å­å’ŒAPIæ•°æ®
         // è¿‡æ»¤æ‰APIä¸­å·²å­˜åœ¨çš„æœ¬åœ°å¸–å­ï¼ˆé¿å…é‡å¤ï¼‰
         const filteredLocalPosts = this.localPublishedPosts.filter(localPost =>
           !apiPosts.some(apiPost => apiPost.id === localPost.id)
         );

         // å°†æœ¬åœ°å‘å¸ƒçš„å¸–å­æ”¾åœ¨å‰é¢ï¼ŒAPIæ•°æ®æ”¾åœ¨åé¢
         this.lostItems = [...filteredLocalPosts, ...apiPosts];
      } else {
        this.errorMessage = apiResponse.message || 'è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥';
      }
    } catch (error) {
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error('è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // æœç´¢åŠŸèƒ½
  async searchPosts(): Promise<void> {
    if (!this.searchText.trim()) {
      // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œé‡æ–°è·å–å½“å‰ç¤¾åŒºçš„æ‰€æœ‰å‘å¸ƒä¿¡æ¯
      await this.getPostList();
      return;
    }

    try {
      this.isLoading = true;
      const url = `${API_BASE_URL}/api/post/search?communityId=${this.selectedCommunityId}&keyword=${encodeURIComponent(this.searchText.trim())}`;

      const response = await HttpUtils.get(url);
      const apiResponse: ApiResponse<SearchResponse> = JSON.parse(response);

      if (apiResponse.code === 200 && apiResponse.data) {
        // å°†æœç´¢ç»“æœè½¬æ¢ä¸ºLostItemæ ¼å¼
         this.lostItems = apiResponse.data.searchResults.map((post: PostInfo): LostItem => {
           const originalTime = post.lostTime || post.publishTime || '';
           return {
             id: post.postId,
             title: post.itemName,
             category: post.itemDescription || 'å…¶ä»–',
             location: post.lostLocation,
             time: this.formatTime(originalTime),
             originalTimestamp: originalTime ? new Date(originalTime).getTime() : 0,
             image: post.images && post.images.length > 0 ? post.images[0] : 'https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B',
             type: post.postType === 'å¯»ç‰©' ? 'å¯»ç‰©' : 'å¯»ä¸»',
             status: post.status === 'å·²æ‰¾åˆ°' ? 'å·²æ‰¾åˆ°' : 'å¯»æ‰¾ä¸­'
           };
         });
      } else {
        this.errorMessage = apiResponse.message || 'æœç´¢å¤±è´¥';
      }
    } catch (error) {
      this.errorMessage = 'æœç´¢è¯·æ±‚å¤±è´¥';
      console.error('æœç´¢å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(timeStr: string): string {
    if (!timeStr) return 'æ—¶é—´æœªçŸ¥';

    try {
      const date = new Date(timeStr);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMinutes = Math.floor(diffMs / (1000 * 60));

      if (diffDays > 7) {
        // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
        return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
      } else if (diffDays > 0) {
        return `${diffDays}å¤©å‰`;
      } else if (diffHours > 0) {
        return `${diffHours}å°æ—¶å‰`;
      } else if (diffMinutes > 0) {
        return `${diffMinutes}åˆ†é’Ÿå‰`;
      } else {
        return 'åˆšåˆš';
      }
    } catch (error) {
      // å¦‚æœæ—¶é—´æ ¼å¼æ— æ³•è§£æï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
      return timeStr;
    }
  }

  // é¡µé¢åˆå§‹åŒ–
  async aboutToAppear(): Promise<void> {
    await this.getCommunityList();
    // getCommunityListä¸­å·²ç»ä¼šè‡ªåŠ¨è°ƒç”¨getPostListï¼Œæ— éœ€é‡å¤è°ƒç”¨
  }

  // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
  onPageShow(): void {
    const params = router.getParams();
    if (params && Reflect.get(params, 'refreshList')) {
      console.log('æ£€æµ‹åˆ°åˆ·æ–°æ ‡å¿—ï¼Œé‡æ–°è·å–åˆ—è¡¨');
      // å…ˆæ¸…é™¤å‚æ•°ï¼Œé¿å…æ— é™å¾ªç¯
      router.replaceUrl({ url: 'pages/MainPage' });
      // å»¶è¿Ÿæ‰§è¡Œåˆ·æ–°ï¼Œç¡®ä¿é¡µé¢å‚æ•°å·²æ¸…é™¤
      setTimeout(() => {
        this.getPostList();
      }, 100);
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å‘å¸ƒçš„å¸–å­ä¿¡æ¯ä¼ é€’è¿‡æ¥
    if (params && Reflect.get(params, 'newPost')) {
      try {
        const newPost: LostItem = JSON.parse(Reflect.get(params, 'newPost') as string);
        this.addLocalPost(newPost);
      } catch (error) {
        console.error('è§£ææ–°å‘å¸ƒå¸–å­ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰å¸–å­çŠ¶æ€æ›´æ–°
    if (params && Reflect.get(params, 'updatedPostId') && Reflect.get(params, 'updatedStatus')) {
      const postId = Reflect.get(params, 'updatedPostId') as string;
      const newStatus = Reflect.get(params, 'updatedStatus') as "å·²æ‰¾åˆ°" | "å¯»æ‰¾ä¸­";
      this.updatePostStatus(postId, newStatus);
      console.log(`æ›´æ–°å¸–å­çŠ¶æ€: ${postId} -> ${newStatus}`);
      // æ¸…é™¤å‚æ•°
      router.replaceUrl({ url: 'pages/MainPage' });
    }
  }

  // æ·»åŠ æ–°å‘å¸ƒçš„å¸–å­åˆ°æœ¬åœ°åˆ—è¡¨
  addLocalPost(post: LostItem): void {
    // æ£€æŸ¥æœ¬åœ°åˆ—è¡¨å’Œå½“å‰æ˜¾ç¤ºåˆ—è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
    const existsInLocal = this.localPublishedPosts.some(local => local.id === post.id);
    const existsInCurrent = this.lostItems.some(current => current.id === post.id);

    if (!existsInLocal && !existsInCurrent) {
      this.localPublishedPosts.push(post);
      // ç«‹å³æ›´æ–°æ˜¾ç¤ºçš„å¸–å­åˆ—è¡¨ï¼Œå°†æ–°å¸–å­æ”¾åœ¨æœ€å‰é¢
      this.lostItems = [post, ...this.lostItems];
      console.log('æˆåŠŸæ·»åŠ æ–°å‘å¸ƒçš„å¸–å­:', post.title);
    } else {
      console.log('å¸–å­å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ :', post.title);
    }
  }

  // æ›´æ–°å¸–å­çŠ¶æ€
  updatePostStatus(postId: string, newStatus: "å·²æ‰¾åˆ°" | "å¯»æ‰¾ä¸­"): void {
    // æ›´æ–°æœ¬åœ°å‘å¸ƒçš„å¸–å­çŠ¶æ€
    const localPostIndex = this.localPublishedPosts.findIndex(post => post.id === postId);
    if (localPostIndex !== -1) {
      this.localPublishedPosts[localPostIndex].status = newStatus;
    }

    // æ›´æ–°å½“å‰æ˜¾ç¤ºåˆ—è¡¨ä¸­çš„å¸–å­çŠ¶æ€
    const currentPostIndex = this.lostItems.findIndex(post => post.id === postId);
    if (currentPostIndex !== -1) {
      this.lostItems[currentPostIndex].status = newStatus;
    }

    console.log(`å¸–å­çŠ¶æ€å·²æ›´æ–°: ${postId} -> ${newStatus}`);
  }

  // è·å–çŠ¶æ€æ–‡æœ¬
  getStatusText(item: LostItem): string {
    if (item.status === 'å·²æ‰¾åˆ°') {
      return 'å·²æ‰¾åˆ°';
    } else {
      return item.type === 'å¯»ç‰©' ? 'å¯»ç‰©' : 'å¯»ä¸»';
    }
  }

  // è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
  getStatusColor(item: LostItem): string {
    if (item.status === 'å·²æ‰¾åˆ°') {
      return '#155724';
    } else {
      return '#856404';
    }
  }

  // è·å–çŠ¶æ€èƒŒæ™¯é¢œè‰²
  getStatusBackgroundColor(item: LostItem): string {
    if (item.status === 'å·²æ‰¾åˆ°') {
      return '#d4edda';
    } else {
      return '#fff3cd';
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'å¤±ç‰©æ‹›é¢†',
        showBack: false,
        showAction: true,
        actionText: 'ğŸ‘¤',
        onAction: () => {
          router.pushUrl({ url: 'pages/ProfilePage' });
        }
      })
      .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Column() {
        // ç¤¾åŒºé€‰æ‹©å™¨
        Column() {
          Row() {
            Column() {
              Text('ç­›é€‰ç¤¾åŒº')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .alignSelf(ItemAlign.Start)
              Text(this.selectedCommunity)
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 2 })
                .alignSelf(ItemAlign.Start)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text(this.showCommunityDropdown ? 'â–²' : 'â–¼')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .padding(12)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .border({ width: 1, color: '#e0e0e0' })
          .onClick(() => {
            this.showCommunityDropdown = !this.showCommunityDropdown;
          })

          // ä¸‹æ‹‰åˆ—è¡¨
          if (this.showCommunityDropdown) {
            Column() {
              // å…¨éƒ¨ç¤¾åŒºé€‰é¡¹
              Row() {
                Text('å…¨éƒ¨ç¤¾åŒº')
                  .fontSize(14)
                  .fontColor('#333333')
                  .layoutWeight(1)

                if (this.selectedCommunity === 'å…¨éƒ¨ç¤¾åŒº') {
                  Text('âœ“')
                    .fontSize(14)
                    .fontColor('#667eea')
                }
              }
              .width('100%')
              .padding({ left: 12, right: 12, top: 10, bottom: 10 })
              .backgroundColor(Color.White)
              .onClick(async () => {
                this.selectedCommunity = 'å…¨éƒ¨ç¤¾åŒº';
                if (this.communities.length > 0) {
                  this.selectedCommunityId = this.communities[0].communityId;
                }
                this.showCommunityDropdown = false;
                // åˆ‡æ¢åˆ°å…¨éƒ¨ç¤¾åŒºåé‡æ–°è·å–å‘å¸ƒä¿¡æ¯
                await this.getPostList();
              })

              if (this.communities.length > 0) {
                Divider()
                  .color('#f0f0f0')
                  .strokeWidth(1)
              }

              ForEach(this.communities, (community: PostCommunityInfo, index: number) => {
                Row() {
                  Text(community.communityName)
                    .fontSize(14)
                    .fontColor('#333333')
                    .layoutWeight(1)

                  if (community.communityName === this.selectedCommunity) {
                    Text('âœ“')
                      .fontSize(14)
                      .fontColor('#667eea')
                  }
                }
                .width('100%')
                .padding({ left: 12, right: 12, top: 10, bottom: 10 })
                .backgroundColor(Color.White)
                .onClick(async () => {
                  this.selectedCommunity = community.communityName;
                  this.selectedCommunityId = community.communityId;
                  this.showCommunityDropdown = false;
                  // åˆ‡æ¢ç¤¾åŒºåé‡æ–°è·å–å‘å¸ƒä¿¡æ¯
                  await this.getPostList();
                })

                if (index < this.communities.length - 1) {
                  Divider()
                    .color('#f0f0f0')
                    .strokeWidth(1)
                }
              })
            }
            .width('100%')
            .backgroundColor(Color.White)
            .borderRadius(8)
            .border({ width: 1, color: '#e0e0e0' })
            .shadow({ radius: 8, color: '#0000001A', offsetX: 0, offsetY: 4 })
            .margin({ top: 4 })
          }
        }
        .width('100%')
        .margin({ bottom: 20 })

        // æœç´¢æ 
        Row() {
          TextInput({ placeholder: 'æœç´¢ç‰©å“åç§°ã€æè¿°...', text: this.searchText })
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .borderRadius(22)
            .backgroundColor(Color.White)
            .border({ width: 1, color: '#ddd' })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.searchText = value;
            })

          Button('ğŸ”')
            .width(44)
            .height(44)
            .backgroundColor('#667eea')
            .borderRadius(22)
            .fontColor(Color.White)
            .fontSize(18)
            .margin({ left: 8 })
            .onClick(async () => {
              await this.searchPosts();
            })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ç­›é€‰æ ‡ç­¾
        Row() {
          ForEach(this.filterTabs, (tab: string) => {
            Text(tab)
              .layoutWeight(1)
              .fontSize(14)
              .fontColor(this.selectedFilter === tab ? '#667eea' : '#666666')
              .fontWeight(this.selectedFilter === tab ? FontWeight.Medium : FontWeight.Normal)
              .backgroundColor(this.selectedFilter === tab ? Color.White : Color.Transparent)
              .borderRadius(6)
              .padding(8)
              .textAlign(TextAlign.Center)
              .onClick(() => {
                this.selectedFilter = tab;
              })
          })
        }
        .width('100%')
        .backgroundColor('#f8f9fa')
        .borderRadius(8)
        .padding(4)
        .margin({ bottom: 20 })

        // åŠ è½½çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
        if (this.isLoading) {
          Row() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#666666')
          }
          .width('100%')
          .height(100)
          .justifyContent(FlexAlign.Center)
        } else if (this.errorMessage) {
          Column() {
            Text('âŒ')
              .fontSize(32)
              .margin({ bottom: 8 })
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#ff4444')
              .textAlign(TextAlign.Center)
            Button('é‡è¯•')
              .fontSize(14)
              .backgroundColor('#667eea')
              .fontColor(Color.White)
              .borderRadius(6)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .margin({ top: 12 })
              .onClick(async () => {
                this.errorMessage = '';
                await this.getCommunityList();
                await this.getPostList();
              })
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          // ç‰©å“åˆ—è¡¨
          List({ space: 16 }) {
          ForEach(this.lostItems.filter(item =>
            this.selectedFilter === 'å…¨éƒ¨' ||
            (this.selectedFilter === 'å·²æ‰¾åˆ°' && item.status === 'å·²æ‰¾åˆ°') ||
            (this.selectedFilter === 'å¯»ç‰©' && item.type === 'å¯»ç‰©' && item.status === 'å¯»æ‰¾ä¸­') ||
            (this.selectedFilter === 'å¯»ä¸»' && item.type === 'å¯»ä¸»' && item.status === 'å¯»æ‰¾ä¸­')
          ).sort((a, b) => {
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰é¢
            return b.originalTimestamp - a.originalTimestamp;
          }), (item: LostItem) => {
            ListItem() {
              Row() {
                // å›¾ç‰‡
                Image(item.image)
                  .width(80)
                  .height(80)
                  .borderRadius(8)
                  .objectFit(ImageFit.Cover)
                  .alt('https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B')
                  .onError(() => {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', item.image);
                  })

                // ä¿¡æ¯
                Column() {
                  Text(item.title)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333333')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 4 })

                  Text(`ğŸ“ ${item.location}`)
                    .fontSize(14)
                    .fontColor('#666666')
                    .margin({ bottom: 2 })
                    .alignSelf(ItemAlign.Start)

                  Text(`â° ${item.time}`)
                    .fontSize(14)
                    .fontColor('#666666')
                    .margin({ bottom: 8 })
                    .alignSelf(ItemAlign.Start)

                  // çŠ¶æ€æ ‡ç­¾
                  Text(this.getStatusText(item))
                    .fontSize(12)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.getStatusColor(item))
                    .backgroundColor(this.getStatusBackgroundColor(item))
                    .borderRadius(12)
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .alignSelf(ItemAlign.Start)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 12 })
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .shadow({ radius: 4, color: '#0000001A', offsetX: 0, offsetY: 2 })
              .onClick(() => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°å‘å¸ƒçš„å¸–å­
                const isLocalPost = this.localPublishedPosts.some(local => local.id === item.id);
                
                if (isLocalPost) {
                   // æœ¬åœ°å‘å¸ƒçš„å¸–å­ï¼Œä¼ é€’å®Œæ•´æ•°æ®
                   router.pushUrl({
                     url: 'pages/DetailPage',
                     params: {
                       postId: item.id,
                       localPostData: JSON.stringify({
                         id: item.id,
                         title: item.title,
                         category: item.category,
                         location: item.location,
                         time: item.time,
                         description: item.description || 'è¿™æ˜¯æˆ‘åˆšåˆšå‘å¸ƒçš„ç‰©å“ä¿¡æ¯',
                         contactInfo: item.contactInfo || 'è”ç³»ç”µè¯ï¼šè¯·é€šè¿‡ç§ä¿¡è”ç³»',
                         images: item.images || [item.image],
                         type: item.type,
                         publisher: item.publisher || 'æˆ‘',
                         status: item.status
                       })
                     }
                   });
                  console.log(`è·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆæœ¬åœ°æ•°æ®ï¼‰ï¼Œä¼ é€’postId: ${item.id}`);
                } else {
                  // APIæ•°æ®ï¼Œåªä¼ é€’postId
                  router.pushUrl({
                    url: 'pages/DetailPage',
                    params: {
                      postId: item.id
                    }
                  });
                  console.log(`è·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆAPIæ•°æ®ï¼‰ï¼Œä¼ é€’postId: ${item.id}`);
                }
              })
            }
          })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20 })
      .backgroundColor('#f8f9fa')
      .layoutWeight(1)

      // æµ®åŠ¨å‘å¸ƒæŒ‰é’®
      Stack() {
        Button('+')
          .width(56)
          .height(56)
          .fontSize(24)
          .fontColor(Color.White)
          .linearGradient({
            angle: 135,
            colors: [['#667eea', 0], ['#764ba2', 1]]
          })
          .borderRadius(28)
          .shadow({ radius: 8, color: '#667eea66', offsetX: 0, offsetY: 4 })
          .position({ x: '100%', y: '100%' })
          .translate({ x: -76, y: -140 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/PublishPage' });
          })
      }
      .width('100%')
      .height(0)

      // åº•éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      BottomTabBar({
        currentIndex: 0,
        onTabClick: (index: number) => {
          NavigationUtils.handleTabNavigation(index, 0);
        }
      })
    }
    .width('100%')
    .height('100%')
  }
}
