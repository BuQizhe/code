// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { HeaderBar } from "../components/CommonComponents"
import { HttpUtils } from '../utils/HttpUtils';
import { ApiResponse, ApiItemData, PublishRequestData } from '../po/CommonTypes';
import { photoAccessHelper } from '@kit.MediaLibraryKit';
import { LostItem } from '../po/LostItem';
import { API_BASE_URL, TimeUtils } from '../utils/Common';


@Entry
@Component
struct PublishPage {
  @State itemType: 'å¯»ç‰©' | 'å¯»ä¸»' = 'å¯»ç‰©';
  @State title: string = '';
  @State category: string = '';
  @State location: string = '';
  @State description: string = '';
  @State contactInfo: string = '';
  @State images: string[] = [];
  @State selectedImageUris: string[] = []; // å­˜å‚¨é€‰æ‹©çš„å›¾ç‰‡URI
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State lostTime: string = TimeUtils.getCurrentDateTime();
  private categories: string[] = ['æ•°ç äº§å“', 'è¯ä»¶å¡ç±»', 'ç”Ÿæ´»ç”¨å“', 'æœé¥°é…é¥°', 'å…¶ä»–']; // ä»…ä¾›å±•ç¤ºï¼Œå®é™…ä»åç«¯è·å–
  
  // è¾“å…¥éªŒè¯é”™è¯¯çŠ¶æ€
  @State titleError: string = '';
  @State categoryError: string = '';
  @State descriptionError: string = '';
  @State contactInfoError: string = '';
  @State lostTimeError: string = '';

  // è¾“å…¥éªŒè¯æ–¹æ³•
  private validateTitle(value: string): void {
    if (!value.trim()) {
      this.titleError = 'ç‰©å“åç§°ä¸èƒ½ä¸ºç©º';
    } else if (value.trim().length > 30) {
      this.titleError = 'ç‰©å“åç§°ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦';
    } else {
      this.titleError = '';
    }
  }
  
  private validateCategory(): void {
    if (!this.category) {
      this.categoryError = 'è¯·é€‰æ‹©ç‰©å“åˆ†ç±»';
    } else {
      this.categoryError = '';
    }
  }
  
  private validateDescription(value: string): void {
    if (!value.trim()) {
      this.descriptionError = 'è¯¦ç»†æè¿°ä¸èƒ½ä¸ºç©º';
    } else if (value.trim().length < 10) {
      this.descriptionError = 'è¯¦ç»†æè¿°è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦';
    } else if (value.trim().length > 500) {
      this.descriptionError = 'è¯¦ç»†æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦';
    } else {
      this.descriptionError = '';
    }
  }
  
  private validateContactInfo(value: string): void {
    if (!value.trim()) {
      this.contactInfoError = 'è”ç³»æ–¹å¼ä¸èƒ½ä¸ºç©º';
    } else if (value.trim().length < 5) {
      this.contactInfoError = 'è”ç³»æ–¹å¼è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦';
    } else if (value.trim().length > 20) {
      this.contactInfoError = 'è”ç³»æ–¹å¼ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦';
    } else {
      this.contactInfoError = '';
    }
  }
  
  private validateLostTime(value: string): void {
    if (!value.trim()) {
      this.lostTimeError = 'æ—¶é—´ä¸èƒ½ä¸ºç©º';
    } else {
      this.lostTimeError = '';
    }
  }
  
  // éªŒè¯æ‰€æœ‰è¾“å…¥
  private validateAllInputs(): boolean {
    this.validateTitle(this.title);
    this.validateCategory();
    this.validateDescription(this.description);
    this.validateContactInfo(this.contactInfo);
    this.validateLostTime(this.lostTime);
    
    return !this.titleError && !this.categoryError && !this.descriptionError && 
           !this.contactInfoError && !this.lostTimeError;
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'å‘å¸ƒæ±‚åŠ©',
        showBack: true,
        showAction: false,
        onBack: () => {
          router.back();
        }
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // å‘å¸ƒç±»å‹é€‰æ‹©
          Row() {
            Button('å¯»ç‰©å¯äº‹')
              .layoutWeight(1)
              .height(44)
              .fontSize(16)
.fontColor(this.itemType === 'å¯»ç‰©' ? Color.White : '#666666')
.backgroundColor(this.itemType === 'å¯»ç‰©' ? undefined : '#f0f0f0')
              .linearGradient(this.itemType === 'å¯»ç‰©' ? {
                angle: 135,
                colors: [['#667eea', 0], ['#764ba2', 1]]
              } : undefined)
              .borderRadius(8)
              .onClick(() => {
this.itemType = 'å¯»ç‰©';
              })
            
            Button('å¤±ç‰©æ‹›é¢†')
              .layoutWeight(1)
              .height(44)
              .fontSize(16)
.fontColor(this.itemType === 'å¯»ä¸»' ? Color.White : '#666666')
              .backgroundColor(this.itemType === 'å¯»ä¸»' ? undefined : '#f0f0f0')
              .linearGradient(this.itemType === 'å¯»ä¸»' ? {
                angle: 135,
                colors: [['#667eea', 0], ['#764ba2', 1]]
              } : undefined)
              .borderRadius(8)
              .margin({ left: 10 })
              .onClick(() => {
this.itemType = 'å¯»ä¸»';
              })
          }
          .width('100%')
          .margin({ bottom: 25 })

          // ç‰©å“æ ‡é¢˜
          Column() {
            Text('ç‰©å“åç§° *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥ç‰©å“åç§°' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.titleError ? '#ff4444' : '#e0e0e0' })
              .onChange((value: string) => {
                this.title = value;
                this.validateTitle(value);
              })
            
            if (this.titleError) {
              Text(this.titleError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 4 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // ç‰©å“åˆ†ç±»
          Column() {
            Text('ç‰©å“åˆ†ç±» *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            // åˆ†ç±»é€‰æ‹©
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.categories, (category: string) => {
                Text(category)
                  .fontSize(14)
                  .fontColor(this.category === category ? Color.White : '#666666')
                  .backgroundColor(this.category === category ? undefined : '#f0f0f0')
                  .linearGradient(this.category === category ? {
                    angle: 135,
                    colors: [['#667eea', 0], ['#764ba2', 1]]
                  } : undefined)
                  .borderRadius(15)
                  .padding({ left: 15, right: 15, top: 8, bottom: 8 })
                  .margin({ right: 10, bottom: 10 })
                  .onClick(() => {
                    this.category = category;
                    this.validateCategory();
                  })
              })
            }
            .width('100%')
            
            if (this.categoryError) {
              Text(this.categoryError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 4 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // è¯¦ç»†æè¿°
          Column() {
            Text('è¯¦ç»†æè¿° *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextArea({ placeholder: 'è¯·è¯¦ç»†æè¿°ç‰©å“ç‰¹å¾ã€ä¸¢å¤±/æ‹¾å¾—ç»è¿‡ç­‰ä¿¡æ¯...' })
              .width('100%')
              .height(100)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.descriptionError ? '#ff4444' : '#e0e0e0' })
              .onChange((value: string) => {
                this.description = value;
                this.validateDescription(value);
              })
            
            if (this.descriptionError) {
              Text(this.descriptionError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 4 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // åœ°ç‚¹ä¿¡æ¯
          Column() {
            Text('ç›¸å…³åœ°ç‚¹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
TextInput({ placeholder: this.itemType === 'å¯»ç‰©' ? 'è¯·è¾“å…¥ä¸¢å¤±åœ°ç‚¹' : 'è¯·è¾“å…¥æ‹¾å¾—åœ°ç‚¹' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: '#e0e0e0' })
              .onChange((value: string) => {
                this.location = value;
              })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // è”ç³»æ–¹å¼
          Column() {
            Text('è”ç³»æ–¹å¼ *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»ç”µè¯æˆ–å¾®ä¿¡å·' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.contactInfoError ? '#ff4444' : '#e0e0e0' })
              .onChange((value: string) => {
                this.contactInfo = value;
                this.validateContactInfo(value);
              })
            
            if (this.contactInfoError) {
              Text(this.contactInfoError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 4 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // å›¾ç‰‡ä¸Šä¼ 
          Column() {
            Text('ä¸Šä¼ å›¾ç‰‡')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            Text('æœ€å¤šå¯ä¸Šä¼ 3å¼ å›¾ç‰‡')
              .fontSize(12)
              .fontColor('#999999')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })
            
            // å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              // å·²é€‰æ‹©çš„å›¾ç‰‡
ForEach(this.images, (imageUri: string, index: number) => {
                Stack() {
                  Image(imageUri)
                    .width(80)
                    .height(80)
                    .borderRadius(8)
                    .objectFit(ImageFit.Cover)
                    .border({ width: 1, color: '#e0e0e0' })
                    .alt('https://dummyimage.com/600x600/f0f0f0/999999.png&text=å›¾ç‰‡')
                  
                  // åˆ é™¤æŒ‰é’®
                  Text('Ã—')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .backgroundColor('#ff4757')
                    .borderRadius(10)
                    .width(20)
                    .height(20)
                    .textAlign(TextAlign.Center)
                    .position({ x: 65, y: -5 })
                    .onClick(() => {
                      this.images.splice(index, 1);
                      this.selectedImageUris.splice(index, 1);
                    })
                }
                .margin({ right: 10, bottom: 10 })
              })
              
              // æ·»åŠ å›¾ç‰‡æŒ‰é’®
if (this.images.length < 3) {
                Stack() {
                  Column()
                    .width(80)
                    .height(80)
                    .borderRadius(8)
                    .backgroundColor('#f8f9fa')
                    .border({ width: 2, color: '#e0e0e0', style: BorderStyle.Dashed })
                  
                  Column() {
                    Text('ğŸ“·')
                      .fontSize(20)
                      .fontColor('#999999')
                    Text('æ·»åŠ ')
                      .fontSize(12)
                      .fontColor('#999999')
                      .margin({ top: 4 })
                  }
                }
                .onClick(async () => {
                  await this.selectPhotos();
                })
              }
            }
            .width('100%')
          }
          .width('100%')
          .margin({ bottom: 30 })

          // æ—¶é—´é€‰æ‹©
          Column() {
            Text('ä¸¢å¤±/æ‹¾å¾—æ—¶é—´ *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥æ—¶é—´', text: this.lostTime })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.lostTimeError ? '#ff4444' : '#e0e0e0' })
              .onChange((value: string) => {
                this.lostTime = value;
                this.validateLostTime(value);
              })
            
            if (this.lostTimeError) {
              Text(this.lostTimeError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 4 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })
          
          // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#ff4444')
              .width('100%')
              .margin({ bottom: 16 })
          }
          
          // å‘å¸ƒæŒ‰é’®
          Button(
            this.itemType === 'å¯»ç‰©' ? 'å‘å¸ƒå¯»ç‰©å¯äº‹' : 'å‘å¸ƒæ‹›é¢†ä¿¡æ¯'
          )
            .width('100%')
            .height(50)
            .fontSize(16)
            .fontColor(Color.White)
            .linearGradient({
              angle: 135,
              colors: [['#667eea', 0], ['#764ba2', 1]]
            })
            .borderRadius(8)
            .enabled(!this.titleError && !this.categoryError && !this.descriptionError && 
                     !this.contactInfoError && !this.lostTimeError && 
                     !!this.title.trim() && !!this.category && !!this.description.trim() &&
                     !!this.contactInfo.trim() && !!this.lostTime.trim())
            .opacity((!this.titleError && !this.categoryError && !this.descriptionError && 
                      !this.contactInfoError && !this.lostTimeError && 
                      this.title.trim() && this.category && this.description.trim() && 
                      this.contactInfo.trim() && this.lostTime.trim()) ? 1.0 : 0.6)
            .onClick(async () => {
              // è¡¨å•éªŒè¯
              if (!this.validateAllInputs()) {
                return;
              }
              
              // æ¸…é™¤é”™è¯¯ä¿¡æ¯å¹¶è®¾ç½®åŠ è½½çŠ¶æ€
              this.errorMessage = '';
              this.isLoading = true;
              
              try {
                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData: PublishRequestData = {
                  itemName: this.title.trim(),
                  itemDescription: this.description.trim(),
                  images: this.images,
                  postType: this.itemType,
                  lostTime: this.lostTime.trim(),
                  lostLocation: this.location.trim(),
                  contact: this.contactInfo.trim(),
                  publisherId: 'user_12345', // é»˜è®¤å€¼ï¼Œå®é™…ä»ç”¨æˆ·ç™»å½•çŠ¶æ€è·å–
                  communityId: 'comm_12345', // é»˜è®¤å€¼ï¼Œå®é™…ä»å½“å‰é€‰æ‹©çš„ç¤¾åŒºè·å–
                };
                
                // å¦‚æœæ˜¯å¯»ä¸»ç±»å‹ï¼Œæ·»åŠ æš‚å­˜åœ°ç‚¹
                if (this.itemType === 'å¯»ä¸»') {
                  requestData.storageLocation = this.location.trim();
                }
                
                // å‘é€APIè¯·æ±‚
                const url = `${API_BASE_URL}/api/post/create`;
                const response = await HttpUtils.post(url, requestData);
                const apiResponse: ApiResponse<ApiItemData> = JSON.parse(response);
                
                if (apiResponse.code === 200 && apiResponse.data) {
                  console.log('å‘å¸ƒæˆåŠŸ:', apiResponse.data);
                  
                  // æ„é€ æ–°å‘å¸ƒçš„å¸–å­ä¿¡æ¯
                  const newPost: LostItem = {
                    id: apiResponse.data.postId || `local_${Date.now()}`, // ä½¿ç”¨APIè¿”å›çš„IDæˆ–ç”Ÿæˆæœ¬åœ°ID
                    title: this.title.trim(),
                    category: this.category,
                    location: this.location.trim(),
                    time: TimeUtils.formatTime(this.lostTime.trim()),
                    originalTimestamp: new Date(this.lostTime.trim()).getTime(),
                    image: this.images.length > 0 ? this.images[0] : 'https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B',
                    type: this.itemType,
                    status: 'å¯»æ‰¾ä¸­',
                    // æ·»åŠ è¯¦ç»†ä¿¡æ¯ç”¨äºè¯¦æƒ…é¡µæ˜¾ç¤º
                    description: this.description,
                    contactInfo: this.contactInfo,
                    images: this.images.length > 0 ? this.images : ['https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B'],
                    publisher: 'æˆ‘'
                  };
                  
                  // å‘å¸ƒæˆåŠŸåï¼Œè¿”å›ä¸»é¡µå¹¶ä¼ é€’æ–°å¸–å­ä¿¡æ¯
                  router.replaceUrl({ 
                    url: 'pages/MainPage',
                    params: {
                      newPost: JSON.stringify(newPost) // ä¼ é€’æ–°å‘å¸ƒçš„å¸–å­ä¿¡æ¯
                    }
                  });
                } else {
                  this.errorMessage = apiResponse.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•';
                }
              } catch (error) {
                this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                console.error('å‘å¸ƒå¤±è´¥:', error);
              } finally {
                this.isLoading = false;
              }
            })
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .backgroundColor('#f8f9fa')
    }
    .width('100%')
    .height('100%')
  }

  // éªŒè¯è¡¨å•
   private validateForm(): boolean {
     if (!this.title.trim()) {
       this.errorMessage = 'è¯·è¾“å…¥ç‰©å“åç§°';
       return false;
     }
     if (!this.category) {
       this.errorMessage = 'è¯·é€‰æ‹©ç‰©å“åˆ†ç±»';
       return false;
     }
     if (!this.description.trim()) {
       this.errorMessage = 'è¯·è¾“å…¥è¯¦ç»†æè¿°';
       return false;
     }
     // ä¸¢å¤±åœ°ç‚¹ä¸ºéå¿…å¡«é¡¹
     // if (!this.location.trim()) {
     //   this.errorMessage = 'è¯·è¾“å…¥ç›¸å…³åœ°ç‚¹';
     //   return false;
     // }
     if (!this.contactInfo.trim()) {
       this.errorMessage = 'è¯·è¾“å…¥è”ç³»æ–¹å¼';
       return false;
     }
     if (!this.lostTime.trim()) {
       this.errorMessage = 'è¯·è¾“å…¥æ—¶é—´';
       return false;
     }
     // å›¾ç‰‡ä¸ºéå¿…é¡»é¡¹
     // if (this.images.length === 0) {
     //   this.errorMessage = 'è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡';
     //   return false;
     // }
     return true;
   }

  // é€‰æ‹©ç…§ç‰‡
  private async selectPhotos(): Promise<void> {
    try {
      const photoSelectOptions = new photoAccessHelper.PhotoSelectOptions();
      photoSelectOptions.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 3;
      
      const photoViewPicker = new photoAccessHelper.PhotoViewPicker();
      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        this.selectedImageUris = photoSelectResult.photoUris;
        this.images = photoSelectResult.photoUris; // æš‚æ—¶ä½¿ç”¨URIä½œä¸ºå›¾ç‰‡è·¯å¾„
        console.info('é€‰æ‹©ç…§ç‰‡æˆåŠŸï¼Œæ•°é‡:', this.images.length);
      }
    } catch (error) {
      console.error('é€‰æ‹©ç…§ç‰‡å¤±è´¥:', error);
      this.errorMessage = 'é€‰æ‹©ç…§ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•';
    }
  }
}
