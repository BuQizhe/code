// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { HeaderBar } from '../components/CommonComponents';

@Entry
@Component
struct RegisterPage {
  @State username: string = '';
  @State phoneNumber: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State avatar: string = '';
  @State errorMessage: string = '';
  @State usernameError: string = '';
  @State phoneError: string = '';
  @State passwordError: string = '';
  @State confirmPasswordError: string = '';
  @State isLoading: boolean = false;

  // éªŒè¯ç”¨æˆ·å
  validateUsername(value: string): string {
    if (!value.trim()) {
      return 'è¯·è¾“å…¥ç”¨æˆ·å';
    }
    if (value.trim().length < 3) {
      return 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä½';
    }
    if (value.trim().length > 20) {
      return 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡20ä½';
    }
    return '';
  }

  // éªŒè¯æ‰‹æœºå·
  validatePhone(value: string): string {
    if (!value.trim()) {
      return 'è¯·è¾“å…¥æ‰‹æœºå·';
    }
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(value.trim())) {
      return 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼';
    }
    return '';
  }

  // éªŒè¯å¯†ç 
  validatePassword(value: string): string {
    if (!value.trim()) {
      return 'è¯·è¾“å…¥å¯†ç ';
    }
    if (value.length < 3) {
      return 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº3ä½';
    }
    if (value.length > 20) {
      return 'å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡20ä½';
    }
    return '';
  }

  // éªŒè¯ç¡®è®¤å¯†ç 
  validateConfirmPassword(value: string): string {
    if (!value.trim()) {
      return 'è¯·ç¡®è®¤å¯†ç ';
    }
    if (value !== this.password) {
      return 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
    }
    return '';
  }

  // æ³¨å†Œæ–¹æ³•
  async register() {
    // éªŒè¯æ‰€æœ‰è¾“å…¥
    this.usernameError = this.validateUsername(this.username);
    this.phoneError = this.validatePhone(this.phoneNumber);
    this.passwordError = this.validatePassword(this.password);
    this.confirmPasswordError = this.validateConfirmPassword(this.confirmPassword);
    
    if (this.usernameError || this.phoneError || this.passwordError || this.confirmPasswordError) {
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      // æ³¨å†Œè¯·æ±‚
      await new Promise<string>(resolve => setTimeout(resolve, 1000));
      
      // æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ°ä¸»é¡µ
      router.pushUrl({ url: 'pages/MainPage' });
    } catch (error) {
      console.error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', error);
      this.errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'æ³¨å†Œ',
        showBack: true,
        onBack: () => {
          router.back();
        },
        showAction: false,
        actionText: 'ğŸ‘¤',
        onAction: () => {
          router.pushUrl({ url: 'pages/ProfilePage' });
        }
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Column() {
        // å¤´åƒä¸Šä¼ 
        Column() {
          Stack() {
            Circle({ width: 80, height: 80 })
              .fill($r('sys.color.glass_material_outline_secondary'))
              .border({ width: 2, color: '#dddddd', style: BorderStyle.Dashed })
            
            Text('ğŸ“·')
              .fontSize(24)
              .fontColor('#999999')
          }
          .margin({ bottom: 20 })
          .onClick(() => {
            console.log('å¤´åƒä¸Šä¼ ç‚¹å‡»');
          })
        }
        .margin({ top: 20, bottom: 20 })

        // è¡¨å•åŒºåŸŸ
        Column() {
          // ç”¨æˆ·åè¾“å…¥
          Column() {
            Text('ç”¨æˆ·å')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.usernameError ? '#ff4444' : '#dddddd' })
              .onChange((value: string) => {
                this.username = value;
                this.usernameError = this.validateUsername(value);
              })
            
            // ç”¨æˆ·åé”™è¯¯æç¤º
            if (this.usernameError) {
              Text(this.usernameError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // æ‰‹æœºå·è¾“å…¥
          Column() {
            Text('æ‰‹æœºå·')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.phoneError ? '#ff4444' : '#dddddd' })
              .type(InputType.PhoneNumber)
              .onChange((value: string) => {
                this.phoneNumber = value;
                this.phoneError = this.validatePhone(value);
              })
            
            // æ‰‹æœºå·é”™è¯¯æç¤º
            if (this.phoneError) {
              Text(this.phoneError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // å¯†ç è¾“å…¥
          Column() {
            Text('å¯†ç ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.passwordError ? '#ff4444' : '#dddddd' })
              .type(InputType.Password)
              .onChange((value: string) => {
                this.password = value;
                this.passwordError = this.validatePassword(value);
                // å¦‚æœç¡®è®¤å¯†ç å·²è¾“å…¥ï¼Œé‡æ–°éªŒè¯ç¡®è®¤å¯†ç 
                if (this.confirmPassword) {
                  this.confirmPasswordError = this.validateConfirmPassword(this.confirmPassword);
                }
              })
            
            // å¯†ç é”™è¯¯æç¤º
            if (this.passwordError) {
              Text(this.passwordError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // ç¡®è®¤å¯†ç è¾“å…¥
          Column() {
            Text('ç¡®è®¤å¯†ç ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.confirmPasswordError ? '#ff4444' : '#dddddd' })
              .type(InputType.Password)
              .onChange((value: string) => {
                this.confirmPassword = value;
                this.confirmPasswordError = this.validateConfirmPassword(value);
              })
            
            // ç¡®è®¤å¯†ç é”™è¯¯æç¤º
            if (this.confirmPasswordError) {
              Text(this.confirmPasswordError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 30 })

          // é”™è¯¯æç¤º
          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#ff4444')
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ top: 15, bottom: 15 })
          }

          // æ³¨å†ŒæŒ‰é’®
          Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(Color.White)
            .linearGradient({
              angle: 135,
              colors: [['#667eea', 0], ['#764ba2', 1]]
            })
            .borderRadius(8)
            .margin({ top: 30 })
            .enabled(!this.isLoading)
            .onClick(() => {
              this.register();
            })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .padding(20)
      .backgroundColor('#f5f5f5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8f9fa')
  }
}