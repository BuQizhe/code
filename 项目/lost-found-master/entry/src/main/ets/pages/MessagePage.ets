// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { MessageItem } from "../po/MessageItem"
import { HeaderBar, BottomTabBar, NavigationUtils } from '../components/CommonComponents';
import { HttpUtils } from '../utils/HttpUtils';
import { ApiResponse, ApiNotificationData, NotificationListResponse, MarkReadRequest } from '../po/CommonTypes';


@Entry
@Component
struct MessagePage {
  @State currentTab: number = 0;
  @State messages: MessageItem[] = [];
  @State isLoading: boolean = false;
  
  // APIé…ç½®
  private baseUrl: string = 'http://rap2api.taobao.org/app/mock/323891';
  private currentUserId: string = 'user_12345'; // å½“å‰ç”¨æˆ·IDï¼Œå®é™…åº”ç”¨ä¸­åº”ä»ç”¨æˆ·çŠ¶æ€è·å–
  
  private tabs: string[] = ['å…¨éƒ¨', 'è¯„è®º', 'ç§ä¿¡'];
  
  // é¡µé¢åˆå§‹åŒ–
  aboutToAppear(): void {
    this.loadNotifications();
  }
  
  // åŠ è½½æ¶ˆæ¯é€šçŸ¥åˆ—è¡¨
  async loadNotifications(): Promise<void> {
    try {
      this.isLoading = true;
      const url = `${this.baseUrl}/api/notification/list?userId=${this.currentUserId}`;
      const response = await HttpUtils.get(url);
      const apiResponse = JSON.parse(response as string) as ApiResponse<NotificationListResponse>;
      
      if (apiResponse.code === 200 && apiResponse.data) {
        this.messages = apiResponse.data.messageList.map((notification: ApiNotificationData) => {
          return {
            id: notification.messageId,
            avatar: this.getAvatarByType(notification.messageType),
            title: this.getTitleByType(notification.messageType, notification.content, notification.senderName),
            preview: notification.content,
            time: this.formatTime(notification.sendTime),
            unreadCount: notification.isRead ? 0 : 1,
            type: this.mapMessageType(notification.messageType),
            senderId: notification.senderId
          } as MessageItem;
        });
      } else {
        console.error('è·å–æ¶ˆæ¯é€šçŸ¥å¤±è´¥:', apiResponse.message);
      }
    } catch (error) {
      console.error('åŠ è½½æ¶ˆæ¯é€šçŸ¥å‡ºé”™:', error);
    } finally {
      this.isLoading = false;
    }
  }
  
  // æ ¹æ®æ¶ˆæ¯ç±»å‹è·å–å¤´åƒ
  private getAvatarByType(messageType: string): string {
    switch (messageType) {
      case 'è¯„è®º':
        return 'ğŸ’¬';
      case 'ç§ä¿¡':
        return 'ğŸ“©';
      default:
        return 'ğŸ””';
    }
  }
  
  // æ ¹æ®æ¶ˆæ¯ç±»å‹å’Œå†…å®¹ç”Ÿæˆæ ‡é¢˜
  private getTitleByType(messageType: string, _content: string, senderName?: string): string {
    switch (messageType) {
      case 'è¯„è®º':
        return 'è¯„è®ºé€šçŸ¥';
      case 'ç§ä¿¡':
        return senderName || 'ç§ä¿¡æ¶ˆæ¯';
      default:
        return 'ç³»ç»Ÿé€šçŸ¥';
    }
  }
  
  // æ˜ å°„æ¶ˆæ¯ç±»å‹
  private mapMessageType(messageType: string): 'comment' | 'private' | 'system' {
    switch (messageType) {
      case 'è¯„è®º':
        return 'comment';
      case 'ç§ä¿¡':
        return 'private';
      default:
        return 'system';
    }
  }
  
  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timeStr: string): string {
    const messageTime = new Date(timeStr);
    const now = new Date();
    const diffMs = now.getTime() - messageTime.getTime();
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffHours < 1) {
      return 'åˆšåˆš';
    } else if (diffHours < 24) {
      return `${diffHours}å°æ—¶å‰`;
    } else if (diffDays === 1) {
      return 'æ˜¨å¤©';
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`;
    } else {
      return messageTime.toLocaleDateString();
    }
  }
  
  // æ ‡è®°æ¶ˆæ¯å·²è¯»
  async markAsRead(messageId: string): Promise<void> {
    try {
      const url = `${this.baseUrl}/api/notification/read`;
      const data: MarkReadRequest = { messageId };
      const response = await HttpUtils.post(url, data);
      const apiResponse = JSON.parse(response as string) as ApiResponse<object>;
      
      if (apiResponse.code === 200) {
        // æ›´æ–°æœ¬åœ°æ¶ˆæ¯çŠ¶æ€
        const updatedMessages: MessageItem[] = [];
        for (const msg of this.messages) {
          if (msg.id === messageId) {
            updatedMessages.push({
              id: msg.id,
              avatar: msg.avatar,
              title: msg.title,
              preview: msg.preview,
              time: msg.time,
              unreadCount: 0,
              type: msg.type,
              senderId: msg.senderId
            });
          } else {
            updatedMessages.push(msg);
          }
        }
        this.messages = updatedMessages;
      } else {
        console.error('æ ‡è®°å·²è¯»å¤±è´¥:', apiResponse.message);
      }
    } catch (error) {
      console.error('æ ‡è®°å·²è¯»å‡ºé”™:', error);
    }
  }
  
  // æ ¹æ®å½“å‰æ ‡ç­¾ç­›é€‰æ¶ˆæ¯
  getFilteredMessages(): MessageItem[] {
    if (this.currentTab === 0) {
      return this.messages; // å…¨éƒ¨
    } else if (this.currentTab === 1) {
      return this.messages.filter(msg => msg.type === 'comment'); // è¯„è®º
    } else {
      return this.messages.filter(msg => msg.type === 'private'); // ç§ä¿¡
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'æ¶ˆæ¯',
        showBack: false,
        showAction: true,
        actionText: 'ğŸ‘¤',
        onAction: () => {
          router.pushUrl({ url: 'pages/ProfilePage' });
        }
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Column() {
        // ç­›é€‰æ ‡ç­¾
        Row() {
          ForEach(this.tabs, (tab: string, index: number) => {
            Text(tab)
              .fontSize(14)
              .fontColor(index === this.currentTab ? '#667eea' : '#666666')
              .fontWeight(index === this.currentTab ? FontWeight.Medium : FontWeight.Normal)
              .padding({ top: 8, bottom: 8 })
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
              .backgroundColor(index === this.currentTab ? Color.White : Color.Transparent)
              .borderRadius(6)
              .onClick(() => {
                this.currentTab = index;
                // åˆ‡æ¢æ ‡ç­¾æ—¶å¯ä»¥é€‰æ‹©æ€§åˆ·æ–°æ•°æ®
                // this.loadNotifications();
              })
          })
        }
        .width('100%')
        .backgroundColor('#f8f9fa')
        .borderRadius(8)
        .padding(4)
        .margin({ left: 20, right: 20, top: 20, bottom: 0 })

        // æ¶ˆæ¯åˆ—è¡¨
        if (this.isLoading && this.messages.length === 0) {
          // åŠ è½½çŠ¶æ€
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 50 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        } else if (this.getFilteredMessages().length === 0) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('æš‚æ— æ¶ˆæ¯')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 50 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        } else {
          List() {
            ForEach(this.getFilteredMessages(), (message: MessageItem) => {
            ListItem() {
              Row() {
                // å¤´åƒ
                if (message.avatar === 'ğŸ””') {
                  Text(message.avatar)
                    .fontSize(20)
                    .width(40)
                    .height(40)
                    .borderRadius(20)
                    .backgroundColor('#667eea')
                    .fontColor(Color.White)
                    .textAlign(TextAlign.Center)
                    .margin({ right: 12 })
                } else {
                  Text(message.avatar)
                    .fontSize(16)
                    .fontColor(Color.White)
                    .width(40)
                    .height(40)
                    .borderRadius(20)
                    .backgroundColor('#667eea')
                    .textAlign(TextAlign.Center)
                    .margin({ right: 12 })
                }
                
                // æ¶ˆæ¯å†…å®¹
                Column() {
                  Text(message.title)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 4 })
                  
                  Text(message.preview)
                    .fontSize(14)
                    .fontColor('#666666')
                    .alignSelf(ItemAlign.Start)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                
                // å³ä¾§æ—¶é—´å’Œæœªè¯»æ ‡è¯†
                Column() {
                  Text(message.time)
                    .fontSize(12)
                    .fontColor('#999999')
                    .alignSelf(ItemAlign.End)
                  
                  if (message.unreadCount && message.unreadCount > 0) {
                    Text(message.unreadCount.toString())
                      .fontSize(12)
                      .fontColor(Color.White)
                      .backgroundColor('#dc3545')
                      .borderRadius(10)
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .margin({ top: 8 })
                      .alignSelf(ItemAlign.End)
                  }
                }
                .alignItems(HorizontalAlign.End)
              }
              .width('100%')
              .padding(16)
              .alignItems(VerticalAlign.Center)
              .onClick(() => {
                // æ ‡è®°æ¶ˆæ¯å·²è¯»
                if (message.unreadCount && message.unreadCount > 0) {
                  this.markAsRead(message.id);
                }
                
                if (message.type === 'private') {
                  // è·³è½¬åˆ°ç§ä¿¡è¯¦æƒ…é¡µ
                  router.pushUrl({ 
                    url: 'pages/ChatPage',
                    params: {
                      contactName: message.title,
                      contactAvatar: message.title ? message.title.charAt(0) : 'ç”¨',
                      otherUserId: message.senderId || 'unknown_user'
                    }
                  });
                } else if (message.type === 'comment') {
                  // è·³è½¬åˆ°è¯„è®ºè¯¦æƒ…é¡µ
                  router.pushUrl({
                    url: 'pages/DetailPage',
                    params: {
                      postId: 'post_2134'
                    }
                  });
                } else {
                  console.log(`ç‚¹å‡»æ¶ˆæ¯: ${message.title}`);
                }
              })
            }
            .backgroundColor(Color.White)
            .border({ width: { bottom: 1 }, color: '#eeeeee' })
          })
          }
          .width('100%')
          .height('100%')
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .layoutWeight(1)
      .backgroundColor('#f8f9fa')

      // åº•éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      BottomTabBar({
        currentIndex: 2,
        onTabClick: (index: number) => {
          NavigationUtils.handleTabNavigation(index, 2);
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8f9fa')
  }
}