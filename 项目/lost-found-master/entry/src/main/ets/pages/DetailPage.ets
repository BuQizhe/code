// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { HeaderBar } from '../components/CommonComponents';
import { ItemData } from "../po/ItemData"
import { CommentData } from "../po/CommentData"
import { HttpUtils } from '../utils/HttpUtils';
import { ApiResponse, CreateClaimRequest, CreateCommentRequest, ApiItemData, ApiCommentData } from '../po/CommonTypes';
import { LostItem } from '../po/LostItem';
import { API_BASE_URL } from '../utils/Common';


@Entry
@Component
struct DetailPage {
  // æ£€æŸ¥ç½‘ç»œè¿æ¥
  private checkNetworkConnection(): void {
    console.log('æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€...');
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç½‘ç»œè¿æ¥æ£€æŸ¥çš„ä»£ç 
    // ä¾‹å¦‚ä½¿ç”¨ç½‘ç»œçŠ¶æ€APIæ£€æŸ¥å½“å‰ç½‘ç»œæ˜¯å¦å¯ç”¨
  }
  
  // ç‰©å“IDï¼Œä»è·¯ç”±å‚æ•°è·å–
  private postId: string = '';
  
  @State itemData: ItemData = {
    id: '',
    title: '',
    category: '',
    location: '',
    time: '',
    description: '',
    contactInfo: '',
    images: [],
    type: 'å¯»ç‰©',
    publisher: '',
    status: 'å¯»æ‰¾ä¸­'
  };
  
  // è¯„è®ºç›¸å…³çŠ¶æ€
  @State comments: CommentData[] = [];
  @State newComment: string = '';
  @State isCommentFocused: boolean = false;
  
  // è®¤é¢†å¼¹çª—ç›¸å…³çŠ¶æ€
  @State showClaimDialog: boolean = false;
  @State claimPhoneNumber: string = '';
  
  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State errorMessage: string = '';

  // é¡µé¢åˆå§‹åŒ–æ—¶è·å–æ•°æ®
  aboutToAppear(): void {
    // ä»è·¯ç”±å‚æ•°è·å–ç‰©å“IDå’Œå¯èƒ½çš„æœ¬åœ°æ•°æ®
    const params = router.getParams();
    if (params && Reflect.get(params, 'postId')) {
      this.postId = Reflect.get(params, 'postId') as string;
      console.log(`é¡µé¢åˆå§‹åŒ–ï¼Œè·å–åˆ°postId: ${this.postId}`);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å¸–å­æ•°æ®ä¼ é€’è¿‡æ¥
      if (params && Reflect.get(params, 'localPostData')) {
        try {
          const localData : LostItem = JSON.parse(Reflect.get(params, 'localPostData') as string);
          this.loadLocalPostData(localData);
          console.log('ä½¿ç”¨æœ¬åœ°å¸–å­æ•°æ®ï¼Œä¸åŠ è½½è¯„è®º');
          // æœ¬åœ°å¸–å­ä¸åŠ è½½è¯„è®ºï¼Œä¿æŒcommentsä¸ºç©ºæ•°ç»„
        } catch (error) {
          console.error('è§£ææœ¬åœ°å¸–å­æ•°æ®å¤±è´¥:', error);
          // è§£æå¤±è´¥æ—¶ä»å°è¯•ä»APIè·å–
          this.checkNetworkConnection();
          this.getItemDetail();
          this.getCommentList();
        }
      } else {
        // æ²¡æœ‰æœ¬åœ°æ•°æ®ï¼Œä»APIè·å–
        this.checkNetworkConnection();
        this.getItemDetail();
        this.getCommentList();
      }
    } else {
      this.errorMessage = 'æœªæ‰¾åˆ°ç‰©å“ID';
      console.error('æœªæ‰¾åˆ°ç‰©å“ID');
    }
  }
  
  // åŠ è½½æœ¬åœ°å¸–å­æ•°æ®
  loadLocalPostData(localData: LostItem): void {
    try {
      this.itemData = {
        id: localData.id || '',
        title: localData.title || '',
        category: localData.category || 'å…¶ä»–',
        location: localData.location || '',
        time: localData.time || '',
        description: localData.description || 'æš‚æ— æè¿°',
        contactInfo: localData.contactInfo || 'æš‚æ— è”ç³»æ–¹å¼',
        images: localData.images && localData.images.length > 0 ? localData.images : ['ğŸ“±'],
        type: localData.type || 'å¯»ç‰©',
        publisher: localData.publisher || 'æˆ‘',
        status: localData.status || 'å¯»æ‰¾ä¸­'
      };
      console.log('æˆåŠŸåŠ è½½æœ¬åœ°å¸–å­æ•°æ®:', this.itemData.title);
    } catch (error) {
      console.error('åŠ è½½æœ¬åœ°å¸–å­æ•°æ®å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½å¸–å­æ•°æ®å¤±è´¥';
    }
  }

  // è·å–ç‰©å“è¯¦æƒ…
  async getItemDetail(): Promise<void> {
    if (!this.postId) {
      console.error('getItemDetail: postIdä¸ºç©ºï¼Œæ— æ³•è·å–ç‰©å“è¯¦æƒ…');
      return;
    }
    
    try {
      this.isLoading = true;
      this.errorMessage = '';
      
      const url = `${API_BASE_URL}/api/post/detail?postId=${this.postId}`;
      console.log(`å¼€å§‹è·å–ç‰©å“è¯¦æƒ…ï¼ŒpostId: ${this.postId}`);
      const response = await HttpUtils.get(url);
      console.log(`ç‰©å“è¯¦æƒ…APIå“åº”: ${response}`);
      
      try {
        const apiResponse: ApiResponse<ApiItemData> = JSON.parse(response);
        console.log(`è§£æåçš„ç‰©å“è¯¦æƒ…æ•°æ®: ${JSON.stringify(apiResponse)}`);
        
        if (apiResponse.code === 200 && apiResponse.data) {
          const postData = apiResponse.data;
          console.log(`ç‰©å“è¯¦æƒ…æ•°æ®: ${JSON.stringify(postData)}`);
          
          // å°†APIè¿”å›çš„æ•°æ®æ˜ å°„åˆ°ItemDataç»“æ„
          // ä»æè¿°ä¸­æå–å…³é”®è¯ï¼ŒåŒ¹é…åˆ°é¢„å®šä¹‰çš„åˆ†ç±»
          let category = 'å…¶ä»–';
          const description = postData.category || '';
          if (description.includes('æ‰‹æœº')) {
            category = 'æ‰‹æœº';
          } else if (description.includes('é’±åŒ…')) {
            category = 'é’±åŒ…';
          } else if (description.includes('é’¥åŒ™')) {
            category = 'é’¥åŒ™';
          } else if (description.includes('èº«ä»½è¯')) {
            category = 'èº«ä»½è¯';
          } else if (description.includes('ä¹¦åŒ…')) {
            category = 'ä¹¦åŒ…';
          }
          
          this.itemData = {
            id: postData.postId || '',
            title: postData.itemName || '',
            category: category,
            location: postData.lostLocation || '',
            time: postData.lostTime || '',
            description: postData.itemDescription || '',
            contactInfo: postData.contact ? `è”ç³»ç”µè¯ï¼š${postData.contact}` : 'æš‚æ— è”ç³»æ–¹å¼',
            images: postData.images ? [postData.images].flat() : ['ğŸ“±'],
            type: postData.postType === 'å¯»ä¸»' ? 'å¯»ä¸»' : 'å¯»ç‰©',
            publisher: postData.publisherId || 'åŒ¿åç”¨æˆ·',
            status: postData.status === 'å·²æ‰¾åˆ°' ? 'å·²æ‰¾åˆ°' : 'å¯»æ‰¾ä¸­'
          };
          
          console.log('è·å–ç‰©å“è¯¦æƒ…æˆåŠŸ:', this.itemData.title);
        } else {
          this.errorMessage = apiResponse.message || 'è·å–ç‰©å“è¯¦æƒ…å¤±è´¥';
          console.error(`è·å–ç‰©å“è¯¦æƒ…å¤±è´¥: code=${apiResponse.code}, message=${apiResponse.message}`);
        }
      } catch (parseError) {
        console.error(`è§£æç‰©å“è¯¦æƒ…JSONå¤±è´¥: ${parseError}`);
        this.errorMessage = 'è§£æå“åº”æ•°æ®å¤±è´¥';
      }
    } catch (error) {
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error(`è·å–ç‰©å“è¯¦æƒ…å¼‚å¸¸: ${error}`);
    } finally {
      this.isLoading = false;
    }
  }
  
  // è·å–è¯„è®ºåˆ—è¡¨
  async getCommentList(): Promise<void> {
    if (!this.postId) {
      console.error('getCommentList: postIdä¸ºç©ºï¼Œæ— æ³•è·å–è¯„è®ºåˆ—è¡¨');
      return;
    }
    
    try {
      console.log(`å¼€å§‹è·å–è¯„è®ºåˆ—è¡¨ï¼ŒpostId: ${this.postId}`);
      const url = `${API_BASE_URL}/api/comment/list?postId=${this.postId}`;
      const response = await HttpUtils.get(url);
      console.log(`è¯„è®ºåˆ—è¡¨APIå“åº”: ${response}`);
      
      try {
        const apiResponse: ApiResponse<ApiCommentData[]> = JSON.parse(response);
        console.log(`è§£æåçš„è¯„è®ºåˆ—è¡¨æ•°æ®: ${JSON.stringify(apiResponse)}`);
        
        if (apiResponse.code === 200 && apiResponse.data) {
          // å°†APIè¿”å›çš„è¯„è®ºæ•°æ®æ˜ å°„åˆ°CommentDataç»“æ„
          this.comments = apiResponse.data.map((comment: ApiCommentData): CommentData => {
            return {
              id: comment.commentId || '',
              userName: comment.commenterName || '',
              content: comment.content || '',
              time: comment.createTime || '',
              avatar: comment.commenterAvatar || '',
              postId: this.postId
            };
          });
          
          console.log(`è·å–è¯„è®ºåˆ—è¡¨æˆåŠŸ, å…± ${this.comments.length} æ¡è¯„è®º`);
          console.log(`è¯„è®ºæ•°æ®: ${JSON.stringify(this.comments)}`);
        } else {
          console.error(`è·å–è¯„è®ºåˆ—è¡¨å¤±è´¥: code=${apiResponse.code}, message=${apiResponse.message}`);
        }
      } catch (parseError) {
        console.error(`è§£æè¯„è®ºåˆ—è¡¨JSONå¤±è´¥: ${parseError}`);
      }
    } catch (error) {
      console.error(`è·å–è¯„è®ºåˆ—è¡¨å¼‚å¸¸: ${error}`);
    }
  }
  
  // å‘é€è¯„è®ºæ–¹æ³•
  async sendComment(): Promise<void> {
    if (this.newComment.trim().length === 0) {
      return;
    }
    
    try {
      const url = `${API_BASE_URL}/api/comment/create`;
      const commentData : CreateCommentRequest = {
        content: this.newComment.trim(),
        postId: this.postId,
        images: [],
        commenterId: 'user_12651', // å½“å‰ç”¨æˆ·ID
        id: '' // è¯„è®ºIDç”±æœåŠ¡å™¨ç”Ÿæˆ
      };
      
      const response = await HttpUtils.post(url, commentData);
      const apiResponse: ApiResponse<ApiCommentData> = JSON.parse(response);
      
      if (apiResponse.code === 200 && apiResponse.data) {
        // åˆ›å»ºæ–°è¯„è®º
        // åˆ›å»ºç¬¦åˆCommentDataæ¥å£çš„å¯¹è±¡
        const newCommentData: CommentData = {
          id: apiResponse.data.commentId || '',
          userName: 'æˆ‘', // å½“å‰ç”¨æˆ·å
          content: this.newComment.trim(),
          time: apiResponse.data.createTime || new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }).replace(/\//g, '-'),
          avatar: 'https://dummyimage.com/600x600/3ee/fff.jpg&text=%E7%A4%BA%E4%BE%8B', // å¯é€‰ï¼Œè®¾ç½®é»˜è®¤å¤´åƒ
          postId: this.postId
        };
        
        // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨
        this.comments.push(newCommentData);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        this.newComment = '';
        
        console.log('å‘è¡¨è¯„è®ºæˆåŠŸ:', newCommentData.content);
      } else {
        console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', apiResponse.message);
      }
    } catch (error) {
      console.error('å‘è¡¨è¯„è®ºå¼‚å¸¸:', error);
    }
  }

  // è·å–çŠ¶æ€æ–‡æœ¬
  getStatusText(): string {
    const status = this.itemData.status || 'searching'; // é»˜è®¤ä¸ºå¯»æ‰¾ä¸­
    if (this.itemData.type === 'å¯»ç‰©') {
      return status === 'å·²æ‰¾åˆ°' ? 'å·²æ‰¾åˆ°' : 'å¯»æ‰¾ä¸­';
    } else {
      return status === 'å·²æ‰¾åˆ°' ? 'å·²è®¤é¢†' : 'å¾…è®¤é¢†';
    }
  }

  // è·å–çŠ¶æ€é¢œè‰²
  getStatusColor(): string {
    const status = this.itemData.status || 'searching'; // é»˜è®¤ä¸ºå¯»æ‰¾ä¸­
    return status === 'å·²æ‰¾åˆ°' ? '#51cf66' : '#ff9500';
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'ç‰©å“è¯¦æƒ…',
        showBack: true,
        showAction: false,
        onBack: () => {
          router.back();
        }
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
          if (this.itemData.images.length > 0) {
            Row() {
              ForEach(this.itemData.images, (image: string) => {
                Image(image)
                  .width(100)
                  .height(100)
                  .borderRadius(8)
                  .objectFit(ImageFit.Cover)
                  .backgroundColor($r('sys.color.glass_material_outline_secondary'))
                  .alt('ğŸ“±')
                  .onError(() => {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', image);
                  })
                  .margin({ right: 10 })
              })
            }
            .width('100%')
            .margin({ bottom: 20 })
          }

          // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
          Column() {
            // æ ‡é¢˜å’ŒçŠ¶æ€
            Row() {
              Text(this.itemData.title)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .layoutWeight(1)
              
              Text(this.itemData.type === 'å¯»ç‰©' ? 'å¯»ç‰©å¯äº‹' : 'å¤±ç‰©æ‹›é¢†')
                .fontSize(14)
                .fontColor(Color.White)
                .backgroundColor(this.itemData.type === 'å¯»ç‰©' ? '#ff6b6b' : '#51cf66')
                .borderRadius(12)
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
            }
            .width('100%')
            .margin({ bottom: 15 })

            // è¯¦ç»†ä¿¡æ¯
            Column() {
              Row() {
                Text('åˆ†ç±»ï¼š')
                  .fontSize(16)
                  .fontColor('#666666')
                  .width(80)
                Text(this.itemData.category)
                  .fontSize(16)
                  .fontColor('#333333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('åœ°ç‚¹ï¼š')
                  .fontSize(16)
                  .fontColor('#666666')
                  .width(80)
                Text(this.itemData.location)
                  .fontSize(16)
                  .fontColor('#333333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('æ—¶é—´ï¼š')
                  .fontSize(16)
                  .fontColor('#666666')
                  .width(80)
                Text(this.itemData.time)
                  .fontSize(16)
                  .fontColor('#333333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('å‘å¸ƒè€…ï¼š')
                  .fontSize(16)
                  .fontColor('#666666')
                  .width(80)
                Text(this.itemData.publisher)
                  .fontSize(16)
                  .fontColor('#333333')
                  .layoutWeight(1)
              }
              .width('100%')
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
          .margin({ bottom: 20 })

          // è¯¦ç»†æè¿°å¡ç‰‡
          Column() {
            Text('è¯¦ç»†æè¿°')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 15 })
            
            Text(this.itemData.description)
              .fontSize(16)
              .fontColor('#666666')
              .lineHeight(24)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 15 })

            // çŠ¶æ€æ ‡è®°
            Row() {
              Text(this.getStatusText())
                .fontSize(14)
                .fontColor(Color.White)
                .backgroundColor(this.getStatusColor())
                .borderRadius(15)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              
              Blank()
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
          .margin({ bottom: 20 })

          // è”ç³»æ–¹å¼å¡ç‰‡
          Column() {
            Text('è”ç³»æ–¹å¼')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 15 })
            
            Text(this.itemData.contactInfo)
              .fontSize(16)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
          .margin({ bottom: 20 })

          // è¯„è®ºåŒºåŸŸ
          Column() {
            // è¯„è®ºæ ‡é¢˜
            Row() {
              Text('è¯„è®º')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
              
              Text(`(${this.comments.length})`)
                .fontSize(16)
                .fontColor('#999999')
                .margin({ left: 5 })
            }
            .width('100%')
            .margin({ bottom: 15 })
            
            // è¯„è®ºåˆ—è¡¨
            if (this.comments.length > 0) {
              Column() {
                ForEach(this.comments, (comment: CommentData, index: number) => {
                  Column() {
                    // è¯„è®ºå¤´éƒ¨ä¿¡æ¯
                    Row() {
                      // ç”¨æˆ·å¤´åƒ
                      Text('ç”¨') // comment.avatar
                        .fontSize(12)
                        .fontColor(Color.White)
                        .width(32)
                        .height(32)
                        .borderRadius(18)
                        .backgroundColor('#667eea')
                        .textAlign(TextAlign.Center)
                      
                      Column() {
                        Text(comment.userName)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#333333')
                          .alignSelf(ItemAlign.Start)
                        
                        Text(comment.time)
                          .fontSize(12)
                          .fontColor('#999999')
                          .alignSelf(ItemAlign.Start)
                          .margin({ top: 2 })
                      }
                      .alignItems(HorizontalAlign.Start)
                      .margin({ left: 10 })
                      .layoutWeight(1)
                    }
                    .width('100%')
                    .margin({ bottom: 10 })
                    
                    // è¯„è®ºå†…å®¹
                    Text(comment.content)
                      .fontSize(15)
                      .fontColor('#333333')
                      .lineHeight(22)
                      .alignSelf(ItemAlign.Start)
                      .margin({ left: 42 })
                  }
                  .width('100%')
                  .padding({ bottom: index < this.comments.length - 1 ? 15 : 0 })
                  .border({
                    width: { bottom: index < this.comments.length - 1 ? 1 : 0 },
                    color: '#f0f0f0'
                  })
                })
              }
              .width('100%')
              .margin({ bottom: 20 })
            } else {
              Text('æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§~')
                .fontSize(14)
                .fontColor('#999999')
                .textAlign(TextAlign.Center)
                .width('100%')
                .margin({ bottom: 20 })
            }
            
            // è¯„è®ºè¾“å…¥åŒºåŸŸ
            Column() {
              Row() {
                TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: this.newComment })
                  .layoutWeight(1)
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#f8f9fa')
                  .borderRadius(20)
                  .padding({ left: 15, right: 15 })
                  .border({ width: this.isCommentFocused ? 1 : 0, color: '#667eea' })
                  .onChange((value: string) => {
                    this.newComment = value;
                  })
                  .onFocus(() => {
                    this.isCommentFocused = true;
                  })
                  .onBlur(() => {
                    this.isCommentFocused = false;
                  })
                
                Button('å‘é€')
                  .width(60)
                  .height(40)
                  .fontSize(14)
                  .fontColor(this.newComment.trim() ? Color.White : '#999999')
                  .backgroundColor(this.newComment.trim() ? '#667eea' : '#f0f0f0')
                  .borderRadius(20)
                  .margin({ left: 10 })
                  .enabled(this.newComment.trim().length > 0)
                  .onClick(() => {
                    this.sendComment();
                  })
              }
              .width('100%')
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
          .margin({ bottom: 30 })
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .backgroundColor('#f8f9fa')

      // åº•éƒ¨æ“ä½œæ 
      Row() {
        Button('ç§ä¿¡Ta')
          .width(80)
          .height(44)
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor($r('sys.color.glass_material_outline_secondary'))
          .borderRadius(8)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/ChatPage',
              params: {
                contactName: this.itemData.publisher || 'ç”¨æˆ·',
                contactAvatar: this.itemData.publisher ? this.itemData.publisher.charAt(0) : 'ç”¨',
                otherUserId: this.itemData.publisher || 'unknown_user'
              }
            });
            console.log('ç§ä¿¡è¯¦æƒ…é¡µ');
          })
        
        // æ ¹æ®ç‰©å“ç±»å‹å’ŒçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®æ–‡æœ¬å’ŒçŠ¶æ€
        if (this.itemData.status === 'å·²æ‰¾åˆ°') {
          // å·²æ‰¾åˆ°/å·²è®¤é¢†çŠ¶æ€
          Button('å·²æ‰¾åˆ°')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor('#51cf66')
            .borderRadius(8)
            .margin({ left: 15 })
            .enabled(false)
        } else {
          // å¯»æ‰¾ä¸­/å¾…è®¤é¢†çŠ¶æ€
          Button(this.itemData.type === 'å¯»ç‰©' ? 'ç¡®è®¤æ‰¾åˆ°' : 'è®¤é¢†')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor(Color.White)
            .linearGradient({
              angle: 135,
              colors: [['#667eea', 0], ['#764ba2', 1]]
            })
            .borderRadius(8)
            .margin({ left: 15 })
            .onClick(() => {
              this.showClaimDialog = true;
            })
        }
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .backgroundColor(Color.White)
      .border({ width: { top: 1 }, color: '#e0e0e0' })
    }
    .width('100%')
    .height('100%')
    .bindContentCover(this.showClaimDialog, this.ClaimDialogBuilder(), {
      modalTransition: ModalTransition.NONE,
      backgroundColor: Color.Transparent,
      onAppear: () => {
        console.log('è®¤é¢†å¼¹çª—æ˜¾ç¤º');
      },
      onDisappear: () => {
        console.log('è®¤é¢†å¼¹çª—éšè—');
        this.claimPhoneNumber = ''; // æ¸…ç©ºè¾“å…¥
      }
    })
  }

  // è®¤é¢†å¼¹çª—æ„å»ºå™¨
  @Builder
  ClaimDialogBuilder() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showClaimDialog = false;
        })
      
      // å¼¹çª—å†…å®¹
      Column() {
        // å¼¹çª—æ ‡é¢˜ - æ ¹æ®ç‰©å“ç±»å‹æ˜¾ç¤ºä¸åŒæ ‡é¢˜
        Text(this.itemData.type === 'å¯»ç‰©' ? 'ç¡®è®¤æ‰¾åˆ°ç‰©å“' : 'è®¤é¢†ç‰©å“')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 20 })
        
        // ç‰©å“ä¿¡æ¯
        Text(this.itemData.type === 'å¯»ç‰©' ? 
          `ç¡®è®¤æ‰¾åˆ°ï¼š${this.itemData.title}` : 
          `ç¡®è®¤è®¤é¢†ï¼š${this.itemData.title}`)
          .fontSize(16)
          .fontColor('#666666')
          .margin({ bottom: 15 })
        
        // æ‰‹æœºå·è¾“å…¥
        Column() {
          Text('è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç ')
            .fontSize(14)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })
          
          TextInput({ 
            placeholder: 'è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ', 
            text: this.claimPhoneNumber 
          })
            .width('100%')
            .height(44)
            .fontSize(16)
            .backgroundColor('#f8f9fa')
            .borderRadius(8)
            .padding({ left: 15, right: 15 })
            .border({ width: 1, color: '#e0e0e0' })
            .type(InputType.PhoneNumber)
            .maxLength(11)
            .onChange((value: string) => {
              this.claimPhoneNumber = value;
            })
        }
        .width('100%')
        .margin({ bottom: 25 })
        
        // æ“ä½œæŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .width(100)
            .height(40)
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor($r('sys.color.glass_material_outline_secondary'))
            .borderRadius(8)
            .onClick(() => {
              this.showClaimDialog = false;
            })
          
          Button(this.itemData.type === 'å¯»ç‰©' ? 'ç¡®è®¤æ‰¾åˆ°' : 'ç¡®è®¤è®¤é¢†')
            .width(120)
            .height(40)
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor(this.isValidPhoneNumber() ? '#667eea' : '#cccccc')
            .borderRadius(8)
            .margin({ left: 15 })
            .enabled(this.isValidPhoneNumber())
            .onClick(() => {
              this.confirmClaim();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
      .width('85%')
      .padding(25)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // éªŒè¯æ‰‹æœºå·æ ¼å¼
  isValidPhoneNumber(): boolean {
    const phoneRegex = /^1[3-9]\d{9}$/;
    return phoneRegex.test(this.claimPhoneNumber);
  }

  // ç¡®è®¤è®¤é¢†
  async confirmClaim(): Promise<void> {
    if (!this.isValidPhoneNumber()) {
      console.log('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
      return;
    }
    
    try {
      const url = `${API_BASE_URL}/api/claim/create`;
      const claimData : CreateClaimRequest = {
        claimerId: 'user_12345', // å‡è®¾å½“å‰ç”¨æˆ·ID
        postId: this.postId,
        claimerPhone: this.claimPhoneNumber
      };
      
      const response = await HttpUtils.post(url, claimData);
      const apiResponse: ApiResponse<CreateClaimRequest> = JSON.parse(response);
      
      if (apiResponse.code === 200) {
        // æ›´æ–°ç‰©å“çŠ¶æ€ä¸ºå·²æ‰¾åˆ°
        this.itemData.status = 'å·²æ‰¾åˆ°';
        
        // å…³é—­å¼¹çª—
        this.showClaimDialog = false;
        
        console.log(`è®¤é¢†æˆåŠŸï¼Œæ‰‹æœºå·ï¼š${this.claimPhoneNumber}`);
        
        // è¿”å›ä¸»é¡µå¹¶ä¼ é€’çŠ¶æ€æ›´æ–°ä¿¡æ¯
        router.back({
          url: 'pages/MainPage',
          params: {
            updatedPostId: this.postId,
            updatedStatus: 'å·²æ‰¾åˆ°'
          }
        });
      } else {
        console.error('è®¤é¢†å¤±è´¥:', apiResponse.message);
      }
    } catch (error) {
      console.error('è®¤é¢†è¯·æ±‚å¼‚å¸¸:', error);
    }
  }
}