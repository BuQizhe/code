// é¡¹ç›®ä½œè€…ï¼šæ¨é’°ç„¶
import { router } from '@kit.ArkUI';
import { HeaderBar } from '../components/CommonComponents';
import { HttpUtils } from '../utils/HttpUtils';
import { ApiResponse } from '../po/CommonTypes';

// ç™»å½•å“åº”æ•°æ®æ¥å£
interface LoginData {
  userId: string;
  username: string;
  phone: string;
  avatar: string;
  registerTime: string;
}

interface LoginRequest extends Record<string, string | number | object> {
  username: string;
  password: string;
}

@Entry
@Component
struct Index {
  @State username: string = '';
  @State password: string = '';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State usernameError: string = '';
  @State passwordError: string = '';

  // éªŒè¯ç”¨æˆ·å
  validateUsername(value: string): string {
    if (!value.trim()) {
      return 'è¯·è¾“å…¥ç”¨æˆ·å';
    }
    if (value.trim().length < 3) {
      return 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä½';
    }
    return '';
  }

  // éªŒè¯å¯†ç 
  validatePassword(value: string): string {
    if (!value.trim()) {
      return 'è¯·è¾“å…¥å¯†ç ';
    }
    if (value.length < 3) {
      return 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº3ä½';
    }
    return '';
  }

  // ç™»å½•æ–¹æ³•
  async login() {
    // éªŒè¯è¾“å…¥
    this.usernameError = this.validateUsername(this.username);
    this.passwordError = this.validatePassword(this.password);
    
    if (this.usernameError || this.passwordError) {
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      const url = 'http://rap2api.taobao.org/app/mock/323891/api/user/login';
      const loginData: LoginRequest = {
        username: this.username,
        password: this.password
      };
      
      const response = await HttpUtils.post(url, loginData);
      const result = JSON.parse(response) as ApiResponse<LoginData>;
      
      if (result.code === 200 && result.data) {
        console.log('ç™»å½•æˆåŠŸ:', result.data);
        // å¯ä»¥åœ¨è¿™é‡Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        // è·³è½¬åˆ°ä¸»é¡µ
        router.pushUrl({ url: 'pages/MainPage' }).catch(() => {
          // TODO: Implement error handling.
        });
      } else {
        this.errorMessage = result.message || 'ç™»å½•å¤±è´¥';
      }
    } catch (error) {
      console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨å¯¼èˆª - ä½¿ç”¨CommonComponents
      HeaderBar({
        title: 'ç™»å½•',
        showBack: false,
        showAction: false
      })
        .margin({ top: 0 })

      // å†…å®¹åŒºåŸŸ
      Column() {
        // æ¬¢è¿åŒºåŸŸ
        Column() {
          Text('ğŸ“±')
            .fontSize(64)
            .fontColor('#667eea')
            .margin({ bottom: 20 })
          
          Text('æ¬¢è¿ä½¿ç”¨')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 10 })
          
          Text('è¿æ¥ç¤¾åŒºï¼Œå¯»æ‰¾å¤±ç‰©')
            .fontSize(16)
            .fontColor('#666666')
        }
        .margin({ top: 40, bottom: 40 })

        // è¡¨å•åŒºåŸŸ
        Column() {
          // ç”¨æˆ·åè¾“å…¥
          Column() {
            Text('ç”¨æˆ·å')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.usernameError ? '#ff4444' : '#dddddd' })
              .onChange((value: string) => {
                this.username = value;
                this.usernameError = this.validateUsername(value);
              })
            
            // ç”¨æˆ·åé”™è¯¯æç¤º
            if (this.usernameError) {
              Text(this.usernameError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // å¯†ç è¾“å…¥
          Column() {
            Text('å¯†ç ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#555555')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .borderRadius(8)
              .backgroundColor(Color.White)
              .border({ width: 1, color: this.passwordError ? '#ff4444' : '#dddddd' })
              .type(InputType.Password)
              .onChange((value: string) => {
                this.password = value;
                this.passwordError = this.validatePassword(value);
              })
            
            // å¯†ç é”™è¯¯æç¤º
            if (this.passwordError) {
              Text(this.passwordError)
                .fontSize(12)
                .fontColor('#ff4444')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 5 })
            }
          }
          .width('100%')
          .margin({ bottom: 30 })

          // é”™è¯¯æç¤º
          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#ff4444')
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 15 })
          }

          // ç™»å½•æŒ‰é’®
          Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(Color.White)
            .linearGradient({
              angle: 135,
              colors: [['#667eea', 0], ['#764ba2', 1]]
            })
            .borderRadius(8)
            .margin({ bottom: 10 })
            .enabled(!this.isLoading)
            .onClick(() => {
              this.login();
            })

          // æ³¨å†ŒæŒ‰é’®
          Button('æ³¨å†Œè´¦å·')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#6c757d')
            .backgroundColor('#f8f9fa')
            .borderRadius(8)
            .border({ width: 1, color: '#dee2e6' })
            .onClick(() => {
              // è·³è½¬æ³¨å†Œé¡µé¢
              router.pushUrl({ url: 'pages/RegisterPage' }).catch(() => {
                // TODO: Implement error handling.
              });
            })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .padding(20)
      .backgroundColor('#f5f5f5')
    }
    .width('100%')
    .height('100%')
  }
}